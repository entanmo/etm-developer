# DApp 开发指南（二）

## ——UPoS 共识机制详解
<img src="/images/guide03.png" style="margin-left:-60px;" >

## ETM 科学家用 UPoS 找到效率、安全与去中心化的均衡点

共识算法是每一个区块链系统的核心所在，也是区别于其他不同区块链系统的关键。ETM 科学家创造性的将 DPoS 与 PoW 算法改进并结合在一起，形成双稳态 UPoS 共识机制，在效率、安全与去中心化三者之间，寻找到一个平衡点，完成了这个不可能的任务。对于开发者来说，深入了解系统的共识机制，有助于掌握由算法带来的相关特性，为开发 DApp 提供指引。

## SHD 完备性

在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）三者不可兼得，称之为 CAP 定理。区块链体系中，类似于 CAP 定理，存在安全性（Security，缩写为“S”）、高性能（High-performance，缩写为“H”）、去中心化（Decentralization，缩写为“D”）三者兼容的 SHD 完备性问题。而这一问题，已成为区块链发展的重要掣肘之一。

## PoW：从共识到分裂

PoW 即 Proof of Work，工作量证明。是一种以比特币为代表的共识机制，矿工通过尝试解决一些复杂的难题来获取出块资格。为了赢取出块奖励，矿工们消耗了大量电力，同时损耗挖矿硬件。由于获胜的概率与算力成正比，矿工也因此陷入了一条唯算力至上的不归路。

这是一场非合作的博弈，谁出块速度最快，谁拿走所有的出块奖励与交易费用，却让其余人消耗了大量能源而无所得。由于共识算法和区块容量的设计，比特币与以太坊基本与高性能 H 绝缘，而 51% 算力的制约，似乎也在一次次的分裂中瓦解无存，让人们开始质疑去中心化 D 的实际状况。

**至此，单纯的 PoW 机制已无 SHD 完备性可言。**

## DPoS：绕不过的中心化

DPoS 即 Delegated Proof of Stake，授权股权证明。DPoS 给出一种思路，将成千上万个节点，通过某种机制（例如持有代币的数量）选举出若干（奇数个）节点，在这几个节点之间进行投票选举出每次的出块节点，而不用在网络中全部节点之间进行选择。

这种机制能够大幅度提升选举效率。在几十个最多上百节点之间进行一致性投票一般来说可以在秒级完成并达到共识。EOS 的超级节点概念 ，以及以太坊规划的2.0，都是这一机制的实践者。DPoS 大幅提高了系统性能 H，却忽视了去中心化 D 的根本意义，**由少数权益拥有者掌握系统的发展方向，本质上和现有的中心化系统并没有太大区别。**

## UPoS：PoW 和 DPoS 双稳态结构打破垄断和中心化趋势，实现 SHD 完备性

PoW 带来的公平会被超性能算力打破，就像每一次的技术革命带来的高性能必然会打破原有的公平。农业的世界如此，工业的世界亦如此、互联网的世界、区块链的世界中，金字塔也在周而复始的形成和坍塌。而 DPoS 带来的高效使得公平被更快的打破，因为没有了算力的公平支撑，金字塔会更快的形成，这就像现实中的各种权证，“超发”和“集中”会更快的形成。

DPoS 的优点是，不同于 PoW，它资源浪费少、更环保、出块速度快。PoW 平均每十分钟产生一个新区块，而大多 PoS 系统只需不到十秒。根据我们的设计，ETM 测试网 3s 以内就可出块，意味着交易确认速度得到极大提升。PoW 的优点在于它理论上安全性更高，因为迄今为止没有任何一个节点拥有全网 51% 算力的假设依然成立。

基于以上考虑，我们设计了 UPoS 共识以实现 SHD 完备性。简单来说，它的工作原理如下：首先，通过上凸函数映射将所有投票人的权益转化为相应的票数；第二步，结合优选机制，在每个出块周期选举出 101 个节点出块；第三步，被选中的矿工参与改进后的挖矿博弈（ETM挖矿比比特币挖矿更经济、去中心化程度更高）；最后一步，混沌排序算法随机选中下一位出块矿工，让安全性进一步提升。

UPoS 算法具体流程如下图所示：

![UPoS 流程](/images/upos_process.png)

▲UPoS 算法流程示意图

### 矿工 Miners

矿工是一种能够记录交易的账户类型。这些账户在整个生态中至关重要，由他们完成并验证交易。任何账户都能够成为矿工，但是只有入选的 101 个账户才能够生成区块。

### 出块周期 Round

每个周期出块的数量是 101 个，即与每轮矿工数量相同。每一轮中，每名矿工快速混沌排序决定出块顺序，每人有 3s 的出块时间。如果未按时出块或者区块未通过验证，则继续快速混沌排序寻找下一个出块矿工。每个区块的生产都需要至少其他 68 名矿工签名确认并广播。

### 区块奖励 Block Rewards

ETM 系统中，矿工是区块的生成者。矿工成功生成区块会获得固定的 Token 奖励。区块奖励占 Token 总量的 48%，共 2.4 亿枚，在 6 年内分配完毕，逐年递减。

> 6 年内的比例分别为 ：12.13%、10.11%、8.09%、8.09%、6.07%、3.51%

出块奖励的变更时间表如下：

| 奖励  | 里程碑                            |
| ----- | :------------------------------- |
| 6 ETM | 初始奖励，直到区块高度 10,112,000 |
| 5 ETM | 阶段 1，直到区块高度 20,224,000   |
| 4 ETM | 阶段 2，直到区块高度 30,336,000   |
| 4 ETM | 阶段 3，直到区块高度 40,448,000   |
| 3 ETM | 阶段 4，直到区块高度 50,560,000   |
| 2 ETM | 阶段 5，直到区块高度 59,328,000   |

### 每轮交易费用 Round Fees

另一个激励措施是每轮的全部交易手续费用，由当前轮所有活跃参与者按比例均分（具体奖励与分红机制详情）。

